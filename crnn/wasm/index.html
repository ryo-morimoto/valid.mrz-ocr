<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRNN MRZ OCR - WASM Speed Test</title>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d9ff; }
    h2 { color: #ff6b6b; margin-top: 30px; }
    .result {
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .success { border-left: 4px solid #4caf50; }
    .error { border-left: 4px solid #f44336; }
    .pending { border-left: 4px solid #ff9800; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    th { background: #0f3460; }
    .highlight { color: #00d9ff; font-weight: bold; }
    button {
      background: #00d9ff;
      color: #000;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      margin: 10px 5px 10px 0;
    }
    button:hover { background: #00b8d9; }
    button:disabled { background: #555; cursor: not-allowed; }
    #log {
      background: #0a0a15;
      padding: 15px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
    }
    .chars { font-family: 'OCR-B', monospace; letter-spacing: 2px; }
  </style>
</head>
<body>
  <h1>ğŸ”¬ CRNN MRZ OCR - WASM Speed Test</h1>

  <div class="result pending" id="status">
    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­
  </div>

  <button id="runTest" onclick="runSpeedTest()">é€Ÿåº¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
  <button onclick="location.reload()">ãƒªã‚»ãƒƒãƒˆ</button>

  <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h2>
  <table>
    <tr>
      <th>é …ç›®</th>
      <th>çµæœ</th>
      <th>åŸºæº–</th>
      <th>åˆ¤å®š</th>
    </tr>
    <tr>
      <td>ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰æ™‚é–“</td>
      <td id="loadTime">-</td>
      <td>&lt; 3000ms</td>
      <td id="loadTimeVerdict">-</td>
    </tr>
    <tr>
      <td>æ¨è«–æ™‚é–“ (10å›å¹³å‡)</td>
      <td id="inferTime">-</td>
      <td>&lt; 1000ms (ç›®æ¨™ &lt;100ms)</td>
      <td id="inferTimeVerdict">-</td>
    </tr>
    <tr>
      <td>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</td>
      <td id="memory">-</td>
      <td>&lt; 100MB</td>
      <td id="memoryVerdict">-</td>
    </tr>
    <tr>
      <td>ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º</td>
      <td id="modelSize">-</td>
      <td>&lt; 10MB</td>
      <td id="modelSizeVerdict">-</td>
    </tr>
  </table>

  <h2>ğŸ“ ãƒ­ã‚°</h2>
  <div id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.0/dist/ort.min.js"></script>
  <script>
    // MRZ æ–‡å­—ã‚»ãƒƒãƒˆ
    const CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<';
    const BLANK_IDX = CHARS.length;

    let session = null;

    function log(msg) {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(msg);
    }

    function setStatus(msg, type) {
      const el = document.getElementById('status');
      el.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${msg}`;
      el.className = `result ${type}`;
    }

    function setResult(id, value, pass) {
      document.getElementById(id).textContent = value;
      document.getElementById(id + 'Verdict').textContent = pass ? 'âœ…' : 'âŒ';
    }

    function decodeOutput(indices) {
      let result = '';
      let prevIdx = -1;

      for (const idx of indices) {
        if (idx === BLANK_IDX) {
          prevIdx = idx;
          continue;
        }
        if (idx !== prevIdx && idx < CHARS.length) {
          result += CHARS[idx];
        }
        prevIdx = idx;
      }

      return result;
    }

    async function runSpeedTest() {
      const btn = document.getElementById('runTest');
      btn.disabled = true;
      setStatus('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'pending');

      try {
        // WASM è¨­å®š
        ort.env.wasm.simd = true;
        ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;
        log(`WASM threads: ${ort.env.wasm.numThreads}`);

        // ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰
        log('ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ä¸­...');
        const loadStart = performance.now();

        session = await ort.InferenceSession.create('./models/mrz_crnn.onnx', {
          executionProviders: ['wasm'],
          graphOptimizationLevel: 'all'
        });

        const loadTime = performance.now() - loadStart;
        log(`ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${loadTime.toFixed(0)}ms`);
        setResult('loadTime', `${loadTime.toFixed(0)}ms`, loadTime < 3000);

        // ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºå–å¾—
        const response = await fetch('./models/mrz_crnn.onnx');
        const blob = await response.blob();
        const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
        log(`ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º: ${sizeMB}MB`);
        setResult('modelSize', `${sizeMB}MB`, blob.size < 10 * 1024 * 1024);

        // ãƒ€ãƒŸãƒ¼å…¥åŠ›ç”Ÿæˆï¼ˆ32x900 ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ« - å®Ÿéš›ã®ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ï¼‰
        const inputData = new Float32Array(1 * 1 * 32 * 280);
        for (let i = 0; i < inputData.length; i++) {
          inputData[i] = Math.random();
        }
        const inputTensor = new ort.Tensor('float32', inputData, [1, 1, 32, 280]);

        // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
        log('ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­...');
        await session.run({ image: inputTensor });

        // é€Ÿåº¦ãƒ†ã‚¹ãƒˆï¼ˆ10å›ï¼‰
        log('æ¨è«–é€Ÿåº¦ãƒ†ã‚¹ãƒˆ (10å›)...');
        const times = [];

        for (let i = 0; i < 10; i++) {
          const start = performance.now();
          const results = await session.run({ image: inputTensor });
          const elapsed = performance.now() - start;
          times.push(elapsed);

          // ãƒ‡ã‚³ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆæœ€å¾Œã®1å›ï¼‰
          if (i === 9) {
            const output = results.output;
            const outputData = output.data;
            const [T, B, C] = output.dims;

            // Greedy decode
            const indices = [];
            for (let t = 0; t < T; t++) {
              let maxIdx = 0;
              let maxVal = outputData[t * C];
              for (let c = 1; c < C; c++) {
                if (outputData[t * C + c] > maxVal) {
                  maxVal = outputData[t * C + c];
                  maxIdx = c;
                }
              }
              indices.push(maxIdx);
            }

            const decoded = decodeOutput(indices);
            log(`ã‚µãƒ³ãƒ—ãƒ«å‡ºåŠ› (ãƒ€ãƒŸãƒ¼å…¥åŠ›): "${decoded}"`);
          }
        }

        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);

        log(`æ¨è«–æ™‚é–“: avg=${avgTime.toFixed(1)}ms, min=${minTime.toFixed(1)}ms, max=${maxTime.toFixed(1)}ms`);
        setResult('inferTime', `${avgTime.toFixed(1)}ms`, avgTime < 1000);

        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
        if (performance.memory) {
          const memMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
          log(`ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ${memMB}MB`);
          setResult('memory', `${memMB}MB`, performance.memory.usedJSHeapSize < 100 * 1024 * 1024);
        } else {
          setResult('memory', 'N/A', true);
        }

        // æœ€çµ‚åˆ¤å®š
        const pass = loadTime < 3000 && avgTime < 1000;
        setStatus(pass ? 'âœ… é€Ÿåº¦åŸºæº–é”æˆ' : 'âŒ é€Ÿåº¦åŸºæº–æœªé”', pass ? 'success' : 'error');

        log('');
        log('========================================');
        log(pass ? 'âœ… VERDICT: WASM é€Ÿåº¦åŸºæº–é”æˆ' : 'âŒ VERDICT: WASM é€Ÿåº¦åŸºæº–æœªé”');
        log('========================================');

      } catch (err) {
        log(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
        setStatus('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', 'error');
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    }

    // åˆæœŸãƒ­ã‚°
    log('CRNN MRZ OCR WASM Speed Test');
    log(`ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`);
    log(`SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined' ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}`);
    log('');
    log('ã€Œé€Ÿåº¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
  </script>
</body>
</html>
